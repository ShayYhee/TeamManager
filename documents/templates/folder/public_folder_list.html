{% extends 'base.html' %}

{% load static %}
{% load custom_filters %}

{% block title %}Public Folders - Team Manager{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<div class="container">
<div class="row justify-content-center">
    <div class="col-lg-10 col-md-12">
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-transparent d-flex align-items-center justify-content-between">
                <h2 class="mb-0"><i class="fas fa-folder-open me-2" style="color: rgba(211, 182, 76, 0.89);"></i> {{ parent.name|default:"Public Folders" }}</h2>
                {% if parent.parent %}
                    <a href="{% url 'public_folder_list' parent.parent.id %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i> Back
                    </a>
                {% elif parent %}
                    <a href="{% url 'public_folder_list' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i> Back
                    </a>
                {% else %}
                    <a href="{% url 'folder_list' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i> Back to Private Folders
                    </a>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="action-bar mb-4">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPublicFolderModal">
                        <i class="fas fa-folder-plus me-1"></i> Create Public Folder
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadPublicFileModal">
                        <i class="fas fa-upload me-1"></i> Upload File
                    </button>
                </div>

                <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3" id="sortable-row">
                    {% for public_folder in public_folders %}
                        <div class="col" data-public-folder-id="{{ public_folder.id }}">
                            <div class="card h-100 position-relative">
                                <div class="card-body text-center">
                                    <a href="{% url 'public_folder_list' public_folder.id %}" class="text-decoration-none">
                                        <i class="fas fa-folder fa-3x mb-2" style="color: rgbahtag(211, 182, 76, 0.89);"></i>
                                        <h6 class="card-title">{{ public_folder.name }}</h6>
                                    </a>
                                    <small class="text-muted">
                                        Public {% if public_folder.department %}for {{ public_folder.department }}{% endif %}
                                        {% if public_folder.team %}in {{ public_folder.team }}{% endif %}
                                    </small>
                                    {% if public_folder.created_by == request.user %}
                                        <div class="dropdown position-absolute top-0 end-0 p-2">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#renamePublicFolderModal{{ public_folder.id }}">Rename</a></li>
                                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#movePublicFolderModal{{ public_folder.id }}">Move</a></li>
                                                <li><a class="dropdown-item text-danger" href="#" onclick="deletePublicFolder({{ public_folder.id }})">Delete</a></li>
                                            </ul>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <!-- Public Folder Modals -->
                        <div class="modal fade" id="renamePublicFolderModal{{ public_folder.id }}" tabindex="-1">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Rename Public Folder</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="renamePublicForm{{ public_folder.id }}">
                                            {% csrf_token %}
                                            <div class="mb-3">
                                                <label for="renamePublicFolderInput{{ public_folder.id }}" class="form-label fw-medium">Folder Name <span class="text-danger">*</span></label>
                                                <input type="text" name="name" class="form-control" id="renamePublicFolderInput{{ public_folder.id }}" value="{{ public_folder.name }}" required>
                                                <div id="renamePublicFolderError{{ public_folder.id }}" class="text-danger small mt-1"></div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="button" class="btn btn-primary" onclick="ajaxRenamePublicFolder({{ public_folder.id }})">
                                            <i class="fas fa-save me-1"></i> Rename
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal fade" id="movePublicFolderModal{{ public_folder.id }}" tabindex="-1">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Move Public Folder</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="movePublicForm{{ public_folder.id }}">
                                            {% csrf_token %}
                                            <div class="mb-3">
                                                <label for="movePublicFolderSelect{{ public_folder.id }}" class="form-label fw-medium">Destination Folder <span class="text-danger">*</span></label>
                                                <select name="new_parent_id" class="form-select" id="movePublicFolderSelect{{ public_folder.id }}" required>
                                                    <option value="">-- Select Destination --</option>
                                                    {% for pf in public_folders %}
                                                        {% if pf.id != public_folder.id %}
                                                            <option value="{{ pf.id }}">{{ pf.name }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                                <div id="movePublicFolderError{{ public_folder.id }}" class="text-danger small mt-1"></div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="button" class="btn btn-primary" onclick="ajaxMovePublicFolder({{ public_folder.id }})">
                                            <i class="fas fa-arrow-right me-1"></i> Move
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    {% for public_file in public_files %}
                        <div class="col" data-file-id="{{ public_file.id }}">
                            <div class="card h-100 position-relative">
                                <div class="card-body text-center">
                                    {% if public_file.original_name|get_file_extension|lower in "jpeg,jpg,png,gif" %}
                                        <a href="#" class="text-decoration-none" data-media-url="{{ public_file.file.url }}" data-media-type="image" data-media-name="{{ public_file.original_name }}">
                                            <i class="fas fa-file-image fa-3x mb-2" style="color: rgba(8, 66, 142, 0.89);"></i>
                                            <h6 class="card-title">{{ public_file.original_name }}</h6>
                                        </a>
                                    {% elif public_file.original_name|get_file_extension|lower == "pdf" %}
                                        <a href="#" class="text-decoration-none" data-media-url="{{ public_file.file.url }}" data-media-type="pdf" data-media-name="{{ public_file.original_name }}">
                                            <i class="fas fa-file-pdf fa-3x mb-2" style="color: rgba(161, 7, 7, 0.89);"></i>
                                            <h6 class="card-title">{{ public_file.original_name }}</h6>
                                        </a>
                                    {% else %}
                                        <a href="{{ public_file.file.url }}" target="_blank" class="text-decoration-none">
                                            {% if public_file.original_name|get_file_extension|lower == "docx" %}
                                                <i class="fas fa-file-word fa-3x mb-2" style="color: rgba(42, 110, 198, 0.89);"></i>
                                            {% elif public_file.original_name|get_file_extension|lower == "csv" %}
                                                <i class="fas fa-file-csv fa-3x mb-2" style="color: rgba(23, 137, 57, 0.89);"></i>
                                            {% elif public_file.original_name|get_file_extension|lower == "xlsx" %}
                                                <i class="fas fa-file-excel fa-3x mb-2" style="color: rgba(23, 137, 57, 0.89);"></i>
                                            {% else %}
                                                <i class="fas fa-file fa-3x mb-2" style="color: rgba(14, 15, 17, 0.89);"></i>
                                            {% endif %}
                                            <h6 class="card-title">{{ public_file.original_name }}</h6>
                                        </a>
                                    {% endif %}
                                    {% if public_file.created_by == request.user %}
                                        <div class="dropdown position-absolute top-0 end-0 p-2">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#renamePublicFileModal{{ public_file.id }}">Rename</a></li>
                                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#movePublicFileModal{{ public_file.id }}">Move</a></li>
                                                <li><a class="dropdown-item text-danger" href="#" onclick="deletePublicFile({{ public_file.id }})">Delete</a></li>
                                            </ul>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <!-- Public File Modals -->
                        <div class="modal fade" id="renamePublicFileModal{{ public_file.id }}" tabindex="-1">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Rename Public File</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="renamePublicFileForm{{ public_file.id }}">
                                            {% csrf_token %}
                                            <div class="mb-3">
                                                <label for="renamePublicFileInput{{ public_file.id }}" class="form-label fw-medium">File Name <span class="text-danger">*</span></label>
                                                <input type="text" name="name" class="form-control" id="renamePublicFileInput{{ public_file.id }}" value="{{ public_file.original_name }}" required>
                                                <div id="renamePublicFileError{{ public_file.id }}" class="text-danger small mt-1"></div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="button" class="btn btn-primary" onclick="ajaxRenamePublicFile({{ public_file.id }})">
                                            <i class="fas fa-save me-1"></i> Rename
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal fade" id="movePublicFileModal{{ public_file.id }}" tabindex="-1">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Move Public File</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="movePublicFileForm{{ public_file.id }}">
                                            {% csrf_token %}
                                            <div class="mb-3">
                                                <label for="movePublicFileSelect{{ public_file.id }}" class="form-label fw-medium">Destination Folder <span class="text-danger">*</span></label>
                                                <select name="new_folder_id" class="form-select" id="movePublicFileSelect{{ public_file.id }}" required>
                                                    <option value="">-- Select Destination --</option>
                                                    {% for pf in public_folders %}
                                                        <option value="{{ pf.id }}">{{ pf.name }}</option>
                                                    {% endfor %}
                                                </select>
                                                <div id="movePublicFileError{{ public_file.id }}" class="text-danger small mt-1"></div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="button" class="btn btn-primary" onclick="ajaxMovePublicFile({{ public_file.id }})">
                                            <i class="fas fa-arrow-right me-1"></i> Move
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    {% if not public_folders and not public_files %}
                        <div class="col-12">
                            <p class="text-muted text-center">No public folders or files here.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Public Folder Modal -->
<div class="modal fade" id="createPublicFolderModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Public Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createPublicFolderForm" method="post" action="{% url 'create_public_folder' %}">
                    {% csrf_token %}
                    <input type="hidden" name="parent" value="{{ parent.id|default:"" }}">
                    <div class="mb-3">
                        <label for="{{ folder_form.name.id_for_label }}" class="form-label fw-medium">Folder Name <span class="text-danger">*</span></label>
                        {{ folder_form.name }}
                        <div id="createPublicFolderError" class="text-danger small mt-1"></div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ folder_form.department.id_for_label }}" class="form-label fw-medium">Department <span class="text-danger">*</span></label>
                        {{ folder_form.department }}
                    </div>
                    <div class="mb-3">
                        <label for="{{ folder_form.team.id_for_label }}" class="form-label fw-medium">Team (optional)</label>
                        {{ folder_form.team }}
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="ajaxCreatePublicFolder()">
                    <i class="fas fa-folder-plus me-1"></i> Create
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Public File Modal -->
<div class="modal fade" id="uploadPublicFileModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Public File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadPublicFileForm" method="post" action="{% url 'upload_public_file' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="folder" value="{{ parent.id|default:"" }}">
                    <div class="mb-3">
                        <label for="{{ file_form.file.id_for_label }}" class="form-label fw-medium">Choose File <span class="text-danger">*</span></label>
                        {{ file_form.file }}
                        <div class="form-text small">Supported formats: PDF, DOCX, images, CSV, XLSX (max 5MB).</div>
                        <div id="uploadPublicFileError" class="text-danger small mt-1"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="ajaxUploadPublicFile()">
                    <i class="fas fa-upload me-1"></i> Upload
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .card { border-radius: 12px; }
    body.dark-mode .card { background: #2d3748; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
    .card-body { padding: 1.5rem; }
    .card:hover { box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); }
    body.dark-mode .card:hover { box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3); }
    .card-title { font-size: 1rem; font-weight: 500; word-break: break-all; color: #2d3748; }
    body.dark-mode .card-title { color: #e2e8f0; }
    .action-bar { background: #f8f9fa; padding: 1rem; border-radius: 8px; display: flex; gap: 1rem; align-items: center; }
    body.dark-mode .action-bar { background: #3b4a6b; }
    .form-label { color: #2d3748; }
    body.dark-mode .form-label { color: #e2e8f0; }
    .form-control, .form-select { border-radius: 8px; border: 1px solid #e2e8f0; }
    body.dark-mode .form-control, body.dark-mode .form-select { background: #4a5568; border-color: #4a5568; color: #e2e8f0; }
    .form-control:focus, .form-select:focus { border-color: #319795; box-shadow: 0 0 0 0.2rem rgba(49, 151, 149, 0.25); }
    .form-text { color: #718096; }
    body.dark-mode .form-text { color: #a0aec0; }
    .dropdown-menu { border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
    body.dark-mode .dropdown-menu { background: #2d3748; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
    .dropdown-item { color: #2d3748; }
    body.dark-mode .dropdown-item { color: #e2e8f0; }
    .dropdown-item:hover { background: #e2e8f0; }
    body.dark-mode .dropdown-item:hover { background: #4a5568; }
    .sortable-ghost { opacity: 0.5; background: #e2e8f0; }
    body.dark-mode .sortable-ghost { background: #4a5568; }
    @media (max-width: 576px) {
        .card-body { padding: 1rem; }
        h2 { font-size: 1.5rem; }
        .btn-sm { font-size: 0.75rem; padding: 4px 8px; }
        .action-bar { flex-direction: column; align-items: stretch; }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.form-select').forEach(select => {
        $(select).select2({
            dropdownParent: $(select).closest('.modal'),
            theme: 'bootstrap-5',
            width: '100%'
        });
    });

    window.ajaxCreatePublicFolder = function() {
        const form = document.getElementById('createPublicFolderForm');
        const formData = new FormData(form);
        const errorDiv = document.getElementById('createPublicFolderError');
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': form.querySelector('input[name="csrfmiddlewaretoken"]').value
            }
        })
        .then(res => {
            if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            return res.json();
        })
        .then(data => {
            if (data.success) {
                $('#createPublicFolderModal').modal('hide');
                const folderGrid = document.querySelector('#sortable-row');
                const newFolder = document.createElement('div');
                newFolder.className = 'col';
                newFolder.dataset.publicFolderId = data.folder_id;
                newFolder.innerHTML = `
                    <div class="card h-100 position-relative">
                        <div class="card-body text-center">
                            <a href="/public_folders/${data.folder_id}/" class="text-decoration-none">
                                <i class="fas fa-folder fa-3x mb-2" style="color: rgba(211, 182, 76, 0.89);"></i>
                                <h6 class="card-title">${formData.get('name')}</h6>
                            </a>
                            <small class="text-muted">
                                Public ${formData.get('department') ? 'for Department' : ''} ${formData.get('team') ? 'in Team' : ''}
                            </small>
                            <div class="dropdown position-absolute top-0 end-0 p-2">
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#renamePublicFolderModal${data.folder_id}">Rename</a></li>
                                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#movePublicFolderModal${data.folder_id}">Move</a></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deletePublicFolder(${data.folder_id})">Delete</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                folderGrid.appendChild(newFolder);
                form.reset();
            } else {
                errorDiv.textContent = Object.values(data.errors)[0]?.join(' ') || 'An error occurred.';
            }
        })
        .catch(err => {
            errorDiv.textContent = 'An error occurred. Please try again.';
            console.error('Error creating public folder:', err);
        });
    };

    window.ajaxRenamePublicFolder = function(folderId) {
        const form = document.getElementById(`renamePublicForm${folderId}`);
        const input = form.querySelector('input[name="name"]');
        const errorDiv = document.getElementById(`renamePublicFolderError${folderId}`);
        fetch(`/public_folders/${folderId}/rename/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': form.querySelector('input[name="csrfmiddlewaretoken"]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `name=${encodeURIComponent(input.value)}`
        })
        .then(res => {
            if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            return res.json();
        })
        .then(data => {
            if (data.success) {
                $(`#renamePublicFolderModal${folderId}`).modal('hide');
                document.querySelector(`[data-public-folder-id="${folderId}"] .card-title`).textContent = input.value;
            } else {
                errorDiv.textContent = data.errors.name ? data.errors.name.join(' ') : 'An error occurred.';
            }
        })
        .catch(err => {
            errorDiv.textContent = 'An error occurred. Please try again.';
            console.error('Error renaming public folder:', err);
        });
    };

    window.ajaxMovePublicFolder = function(folderId) {
        const form = document.getElementById(`movePublicForm${folderId}`);
        const select = form.querySelector('select[name="new_parent_id"]');
        const errorDiv = document.getElementById(`movePublicFolderError${folderId}`);
        fetch(`/public_folders/${folderId}/move/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': form.querySelector('input[name="csrfmiddlewaretoken"]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `new_parent_id=${encodeURIComponent(select.value)}`
        })
        .then(res => {
            if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            return res.json();
        })
        .then(data => {
            if (data.success) {
                $(`#movePublicFolderModal${folderId}`).modal('hide');
                document.querySelector(`[data-public-folder-id="${folderId}"]`).remove();
            } else {
                errorDiv.textContent = data.errors.new_parent_id ? data.errors.new_parent_id.join(' ') : 'An error occurred.';
            }
        })
        .catch(err => {
            errorDiv.textContent = 'An error occurred. Please try again.';
            console.error('Error moving public folder:', err);
        });
    };

    window.deletePublicFolder = function(folderId) {
        if (confirm('Are you sure you want to delete this public folder?')) {
            fetch(`/public_folders/${folderId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            })
            .then(res => {
                if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
                return res.json();
            })
            .then(data => {
                if (data.success) {
                    document.querySelector(`[data-public-folder-id="${folderId}"]`).remove();
                } else {
                    alert('Failed to delete public folder: ' + (data.errors.folder || 'Unknown error'));
                }
            })
            .catch(err => {
                alert('An error occurred. Please try again.');
                console.error('Error deleting public folder:', err);
            });
        }
    };

    window.ajaxUploadPublicFile = function() {
        const form = document.getElementById('uploadPublicFileForm');
        const formData = new FormData(form);
        const errorDiv = document.getElementById('uploadPublicFileError');
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': form.querySelector('input[name="csrfmiddlewaretoken"]').value
            }
        })
        .then(res => {
            if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            return res.json();
        })
        .then(data => {
            if (data.success) {
                $('#uploadPublicFileModal').modal('hide');
                const folderGrid = document.querySelector('#sortable-row');
                const newFile = document.createElement('div');
                newFile.className = 'col';
                newFile.dataset.fileId = data.file_id;
                const fileName = data.original_name || formData.get('file').name;
                const fileUrl = data.file_url || `/media/uploads/public/${fileName}`;
                const fileExt = (data.original_name || fileName).split('.').pop().toLowerCase();
                let iconClass = 'fas fa-file';
                let iconColor = 'rgba(14, 15, 17, 0.89)';
                let linkAttrs = `href="${fileUrl}" target="_blank"`;
                if (['jpeg', 'jpg', 'png', 'gif'].includes(fileExt)) {
                    iconClass = 'fas fa-file-image';
                    iconColor = 'rgba(8, 66, 142, 0.89)';
                    linkAttrs = `href="#" data-media-url="${fileUrl}" data-media-type="image" data-media-name="${fileName}"`;
                } else if (fileExt === 'pdf') {
                    iconClass = 'fas fa-file-pdf';
                    iconColor = 'rgba(161, 7, 7, 0.89)';
                    linkAttrs = `href="#" data-media-url="${fileUrl}" data-media-type="pdf" data-media-name="${fileName}"`;
                } else if (fileExt === 'docx') {
                    iconClass = 'fas fa-file-word';
                    iconColor = 'rgba(42, 110, 198, 0.89)';
                } else if (fileExt === 'csv') {
                    iconClass = 'fas fa-file-csv';
                    iconColor = 'rgba(23, 137, 57, 0.89)';
                } else if (fileExt === 'xlsx') {
                    iconClass = 'fas fa-file-excel';
                    iconColor = 'rgba(23, 137, 57, 0.89)';
                }
                newFile.innerHTML = `
                    <div class="card h-100 position-relative">
                        <div class="card-body text-center">
                            <a ${linkAttrs} class="text-decoration-none">
                                <i class="${iconClass} fa-3x mb-2" style="color: ${iconColor};"></i>
                                <h6 class="card-title">${fileName}</h6>
                            </a>
                            <div class="dropdown position-absolute top-0 end-0 p-2">
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#renamePublicFileModal${data.file_id}">Rename</a></li>
                                    <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#movePublicFileModal${data.file_id}">Move</a></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deletePublicFile(${data.file_id})">Delete</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                folderGrid.appendChild(newFile);
                form.reset();
                // Trigger a refresh if the DOM update seems incomplete
                if (!document.querySelector(`[data-file-id="${data.file_id}"]`)) {
                    console.warn('File not found in DOM after append, refreshing page.');
                    window.location.reload();
                }
            } else {
                errorDiv.textContent = Object.values(data.errors)[0]?.join(' ') || 'An error occurred during file upload.';
                console.error('Upload error:', data.errors);
            }
        })
        .catch(err => {
            errorDiv.textContent = 'An error occurred. Please try again.';
            console.error('Error uploading public file:', err);
            // Fallback to page refresh on error
            setTimeout(() => window.location.reload(), 2000);
        });
    };

    window.ajaxRenamePublicFile = function(fileId) {
        const form = document.getElementById(`renamePublicFileForm${fileId}`);
        const input = form.querySelector('input[name="name"]');
        const errorDiv = document.getElementById(`renamePublicFileError${fileId}`);
        fetch(`/public_folders/files/${fileId}/rename/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': form.querySelector('input[name="csrfmiddlewaretoken"]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `name=${encodeURIComponent(input.value)}`
        })
        .then(res => {
            if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            return res.json();
        })
        .then(data => {
            if (data.success) {
                $(`#renamePublicFileModal${fileId}`).modal('hide');
                document.querySelector(`[data-file-id="${fileId}"] .card-title`).textContent = input.value;
            } else {
                errorDiv.textContent = data.errors.name ? data.errors.name.join(' ') : 'An error occurred.';
            }
        })
        .catch(err => {
            errorDiv.textContent = 'An error occurred. Please try again.';
            console.error('Error renaming public file:', err);
        });
    };

    window.ajaxMovePublicFile = function(fileId) {
        const form = document.getElementById(`movePublicFileForm${fileId}`);
        const select = form.querySelector('select[name="new_folder_id"]');
        const errorDiv = document.getElementById(`movePublicFileError${fileId}`);
        fetch(`/public_folders/files/${fileId}/move/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': form.querySelector('input[name="csrfmiddlewaretoken"]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `new_folder_id=${encodeURIComponent(select.value)}`
        })
        .then(res => {
            if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            return res.json();
        })
        .then(data => {
            if (data.success) {
                $(`#movePublicFileModal${fileId}`).modal('hide');
                document.querySelector(`[data-file-id="${fileId}"]`).remove();
            } else {
                errorDiv.textContent = data.errors.new_folder_id ? data.errors.new_folder_id.join(' ') : 'An error occurred.';
            }
        })
        .catch(err => {
            errorDiv.textContent = 'An error occurred. Please try again.';
            console.error('Error moving public file:', err);
        });
    };

    window.deletePublicFile = function(fileId) {
        if (confirm('Are you sure you want to delete this public file?')) {
            fetch(`/public_folders/files/${fileId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            })
            .then(res => {
                if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
                return res.json();
            })
            .then(data => {
                if (data.success) {
                    document.querySelector(`[data-file-id="${fileId}"]`).remove();
                } else {
                    alert('Failed to delete public file: ' + (data.errors.file || 'Unknown error'));
                }
            })
            .catch(err => {
                alert('An error occurred. Please try again.');
                console.error('Error deleting public file:', err);
            });
        }
    };

    new Sortable(document.querySelector('#sortable-row'), {
        animation: 150,
        ghostClass: 'sortable-ghost',
        onEnd: function(evt) {
            const folderId = evt.item.dataset.publicFolderId;
            if (folderId) {
                $(`#movePublicFolderModal${folderId}`).modal('show');
            }
        }
    });
});
</script>
{% endblock %}